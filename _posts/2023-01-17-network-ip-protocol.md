---
layout: post
title: network ip protocol
date: 2023-01-17
description: 
tags: network
categories: programming
---

## IP地址
IP地址是IP协议提供的一种统一的地址格式，它为互联网上的每一个网络和每一台主机分配一个逻辑地址，以此来屏蔽物理地址的差异。

首先出现的IP地址是IPV4，是一个32位的二进制数，通常被分割为4个“8位二进制数”（也就是4个字节）。IP地址通常用“点分十进制”表示成（a.b.c.d）的形式，其中，a,b,c,d都是0~255之间的十进制整数。

IPv6是下一版本的互联网协议，IPv6采用128位地址长度。在IPv6的设计过程中除了一劳永逸地解决了地址短缺问题以外，还考虑了在IPv4中解决不好的其它问题。主要有端到端IP连接、服务质量（QoS）、安全性、多播、移动性、即插即用等。

### IP地址编址方式
最初设计互联网络时，为了便于寻址以及层次化构造网络，每个IP地址包括两个标识码（ID），即网络ID和主机ID。同一个物理网络上的所有主机都使用同一个网络ID，网络上的一个主机（包括网络上工作站，服务器等）有一个主机ID与其对应。Internet委员会定义了5种IP地址类型以适合不同容量的网络，即A类~E类。

其中A、B、C3类（如下表格）由InternetNIC在全球范围内统一分配，D、E类为特殊地址。


<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.html path="assets/img/network-ip-address.png" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
  IP地址编址方式
</div>

* A类IP地址

一个A类IP地址是指， 在IP地址的四段号码中，第一段号码为网络号码，剩下的三段号码为本地计算机的号码。如果用二进制表示IP地址的话，A类IP地址就由1字节的网络地址和3字节主机地址组成，网络地址的最高位必须是“0”。

* B类IP地址

一个B类IP地址是指，在IP地址的四段号码中，前两段号码为网络号码。如果用二进制表示IP地址的话，B类IP地址就由2字节的网络地址和2字节主机地址组成，网络地址的最高位必须是“10”。

* C类IP地址

一个C类IP地址是指，在IP地址的四段号码中，前三段号码为网络号码，剩下的一段号码为本地计算机的号码。如果用二进制表示IP地址的话，C类IP地址就由3字节的网络地址和1字节主机地址组成，网络地址的最高位必须是“110”。

* D类IP地址

D类IP地址在历史上被叫做多播地址(multicast address)，即组播地址。在以太网中，多播地址命名了一组应该在这个网络中应用接收到一个分组的站点。多播地址的最高位必须是“1110”，范围从224.0.0.0到239.255.255.255。

* 特殊的网址
  * 每一个字节都为0的地址（“0.0.0.0”）对应于当前主机；
  * IP地址中的每一个字节都为1的IP地址（“255．255．255．255”）是当前子网的广播地址；
  * IP地址中凡是以“11110”开头的E类IP地址都保留用于将来和实验使用。
  * IP地址中不能以十进制“127”作为开头，该类地址中数字127．0．0．1到127．255．255．255用于回路测试，如：127.0.0.1可以代表本机IP地址，用“http://127.0.0.1”就可以测试本机中配置的Web服务器。
  * 网络ID的第一个6位组也不能全置为“0”，全“0”表示本地网络。

* 子网

引入子网掩码(NetMask)，从逻辑上把一个大网络划分成一些小网络。子网掩码是由一系列的1和0构成，通过将其同IP地址做“与”运算来指出一个IP地址的网络号是什么。对于传统IP地址分类来说，A类地址的子网掩码是255.0.0.0；B类地址的子网掩码是255.255.0.0；C类地址的子网掩码是255.255.255.0。

### DHCP

TCP/IP协议需要针对不同的网络进行不同的设置，且每个节点一般需要一个“IP地址”、一个“子网掩码”、一个“默认网关”。不过，可以通过动态主机配置协议（DHCP），给客户端自动分配一个IP地址，避免了出错，也简化了TCP/IP协议的设置。

DHCP协议支持C/S（客户端/服务器）结构，主要分为两部分：
* 1、DHCP客户端：通常为网络中的PC、打印机等终端设备，使用从DHCP服务器分配下来的IP信息，包括IP地址、DNS等。
* 2、DHCP服务器：所有的IP网络设定信息都由DHCP服务器集中管理，并处理客户端的DHCP请求。

DHCP采用UDP作为传输协议，客户端发送消息到DHCP服务器的的67号端口，服务器返回消息给客户端的68号端口。

DHCP服务器为客户端分配IP地址有三种形式：
* 1、管理员将一个IP地址固定分配给一个客户端。
* 2、随机地将地址永久性分配给客户端。
* 3、随机地将地址分配给客户端使用一段时间。

第三种是最常见的使用形式。地址的有效使用时间段称为租用期，租用期满之前，客户端必须向服务器请求继续租用。服务器接受请求后才能继续使用，否则无条件放弃。

默认情况下，路由器隔离广播包，不会将收到的广播包从一个子网发送到另一个子网。当DHCP服务器和客户端不在同一个子网时，充当客户端默认网关的路由器将广播包发送到DHCP服务器所在的子网，这一功能就称为DHCP中继（DHCP Relay）。

DHCP在工作过程中涉及到的报文种类及其作用如下：
* 1、DHCP DISCOVER：客户端开始DHCP过程的第一个报文，是请求IP地址和其它配置参数的广播报文。
* 2、DHCP OFFER：服务器对DHCP DISCOVER报文的响应，是包含有效IP地址及配置的单播（或广播）报文。
* 3、DHCP REQUEST：客户端对DHCP OFFER报文的响应，表示接受相关配置。客户端续延IP地址租期时也会发出该报文。
* 4、DHCP DECLINE：当客户端发现服务器分配的IP地址无法使用（如IP地址冲突时），将发出此报文，通知服务器禁止使用该IP地址。
* 5、DHCP ACK ：服务器对客户端的DHCP REQUEST报文的确认响应报文。客户端收到此报文后，才真正获得了IP地址和相关的配置信息。
* 6、DHCP NAK：服务器对客户端的DHCP REQUEST报文的拒绝响应报文。客户端收到此报文后，会重新开始新的DHCP过程。
* 7、DHCP RELEASE：客户端主动释放服务器分配的IP地址。当服务器收到此报文后，则回收该IP地址，并可以将其分配给其它的客户端。
* 8、DHCP INFORM：客户端获得IP地址后，发送此报文请求获取服务器的其它一些网络配置信息，如DNS等。

DHCP服务器向DHCP客户端出租的IP地址一般都有一个租借期限，期满后DHCP服务器便会收回出租的IP地址。为了能继续使用原先的IP地址，DHCP客户端会向DHCP服务器发送续租的请求。

DHCP续租的工作流程描述如下：
* 1、在使用租期过去50%时刻处， 客户端向服务器发送单播DHCP REQUEST报文续延租期。
* 2、如果收到服务器的DHCP ACK报文，则租期相应向前延长，续租成功。如果没有收到DHCP ACK报文，则客户端继续使用这个IP地址。在使用租期过去87.5%时刻处，向服务器发送广播DHCP REQUEST报文续延租期。
* 3、如果收到服务器的DHCP ACK报文，则租期相应向前延长，续租成功。如果没有收到DHCP ACK报文，则客户端继续使用这个IP地址。在使用租期到期时，客户端自动放弃使用这个IP地址，并开始新的DHCP过程。

