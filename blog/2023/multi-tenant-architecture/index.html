<!DOCTYPE html> <html lang="cn"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Salesforce元数据驱动的多租户架构 | Jun Chen</title> <meta name="author" content="Jun Chen"> <meta name="description" content="chenjun personal site and blog "> <meta name="keywords" content="blog"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://chenjun305.github.io/blog/2023/multi-tenant-architecture/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Jun Chen</span></a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">resume</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Salesforce元数据驱动的多租户架构</h1> <p class="post-meta">August 1, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/architecture"> <i class="fas fa-hashtag fa-sm"></i> architecture</a>     ·   <a href="/blog/category/programming"> <i class="fas fa-tag fa-sm"></i> programming</a>   </p> </header> <article class="post-content"> <p>近段时间，我主要在从事CRM系统的架构工作，自然对业界相关的技术进行了一些调研，Salesforce是CRM领域的标杆和鼻祖，也是全球企业信息服务界的龙头。本文记录我调研整理的Salesforce的后端技术架构相关信息。</p> <h3 id="salesforce简介">Salesforce简介</h3> <h4 id="salesforce发展史">Salesforce发展史</h4> <p>Salesforce的创立者叫Marc Benioff。1999年时，他27岁，为当时美国一家软件巨头Oracle最年轻的高级副总裁。20世纪90年代中后期，像Oracle这样的企业售卖软件按Licence（对付费用户进行授权，以正常使用软件的完整功能）收费，并由软件厂商去部署安装。Marc任Oracle高级副总裁期间，形成了将CRM等通用软件通过互联网部署的想法：用云端模式交付，使用者则像“交水电费那样为自己的软件付费。但他的想法并没有得到前东家的认可，于是决定创业，1999年3月，Salesforce诞生。</p> <ul> <li>1999年，由前甲骨文高管Marc Benioff创立</li> <li>2001年，推出了第一款SaaS应用CRM，受到热议</li> <li>2004年，纽交所上市，市值10亿美元，股票代码CRM</li> <li>2005年，推出了名为“AppExchange”的程序商店</li> <li>2007年，推出了PaaS平台Force.com，让用户更方便地开发在线应用</li> <li>2009年，推出了”Service Cloud”在线客户服务应用</li> <li>2012年，推出“Marketing Cloud”</li> <li>2015年，构建电商云</li> <li>2016年，推出了AI产品Einstein，将AI技术引入到SaaS服务中</li> <li>2019年，收购数据分析平台Tableau</li> <li>2021年，收购企业通讯SaaS软件Slack，补强协同办公功能</li> </ul> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-history-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-history-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-history-1400.webp"></source> <img src="/assets/img/salesforce-history.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Salesforce发展史中的重要节点 </div> <h4 id="全球crm市场份额">全球CRM市场份额</h4> <p>Salesforce近年来在 CRM 行业的市场份额稳居第一，2021 年市占率为 23.8%，SAP 和 Microsoft 位列 第二和第三，市占率均不及 5.5%，与 Salesforce 的差距较大</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/crm-share-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/crm-share-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/crm-share-1400.webp"></source> <img src="/assets/img/crm-share.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> 全球CRM市场份额 </div> <h4 id="salesforce付费模式">Salesforce付费模式</h4> <p>Salesforce采用的是订阅付费模式，用户的续费率至关重要。如果Salesforce的产品不能为企业创造真正的价值，那么第二期的续费将得不到保证。</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/sales-cloud-pricing-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/sales-cloud-pricing-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/sales-cloud-pricing-1400.webp"></source> <img src="/assets/img/sales-cloud-pricing.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Salesforce订阅付费模式 </div> <p>同时其订阅费用采用阶梯定价的收费模式，产品能力是吸引客户提升付费等级的关键因素。</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/sales-cloud-pricing2-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/sales-cloud-pricing2-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/sales-cloud-pricing2-1400.webp"></source> <img src="/assets/img/sales-cloud-pricing2.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Salesforce的阶梯定价收费模式 </div> <h4 id="salesforce围绕crm的4朵云">Salesforce围绕CRM的4朵云</h4> <ul> <li>销售云（sales cloud) <ul> <li>服务于销售部门，销售流程的规范化和提升销售效率。销售线索、潜在客户的获取， 销售流程的自动化推进，销售过程跟踪和共享。</li> </ul> </li> <li>服务云（service cloud） <ul> <li>服务于客服部门，高效互动，提升客服效率。Salesforce呼叫中心提供多渠道、全时段的客户服务支持，客户行为记录以提供个性化服务。</li> </ul> </li> <li>营销云（marketing cloud） <ul> <li>服务于市场部门，营销策略的管理和销售数据传递。用户画像、定制化的营销方式、社交媒体营销、数字化营销、跨渠道营销。</li> </ul> </li> <li>商业云（commerce cloud） <ul> <li>提供商业变现的渠道。企业在线上进行直接的销售，提供交易撮合、订单管理等商业服务，提升消费体验。</li> </ul> </li> </ul> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-income-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-income-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-income-1400.webp"></source> <img src="/assets/img/salesforce-income.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Salesforce公司收入结构 </div> <h4 id="salesforce产品矩阵">Salesforce产品矩阵</h4> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-product-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-product-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-product-1400.webp"></source> <img src="/assets/img/salesforce-product.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Salesforce产品矩阵 </div> <h3 id="技术架构">技术架构</h3> <p>企业运维架构经历了从On-Premises(自建机房) -&gt; IaaS(基础设施即服务) -&gt; PaaS（平台即服务） -&gt; SaaS（软件即服务）的演进，越往后，企业所要关注的点越少。</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/platform-architecture1-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/platform-architecture1-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/platform-architecture1-1400.webp"></source> <img src="/assets/img/platform-architecture1.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> 企业运维架构的演进 </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/platform-architecture2-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/platform-architecture2-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/platform-architecture2-1400.webp"></source> <img src="/assets/img/platform-architecture2.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> 主要代表平台 </div> <p>Salesforce是SaaS和PaaS思想的首推者。<br> 构成其平台能力的核心主要是其元数据驱动的多租户架构。</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-architecture1-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-architecture1-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-architecture1-1400.webp"></source> <img src="/assets/img/salesforce-architecture1.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Salesforce的技术架构 </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-core-architecture-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-core-architecture-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-core-architecture-1400.webp"></source> <img src="/assets/img/salesforce-core-architecture.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Salesforce技术架构的核心 </div> <h3 id="多租户架构">多租户架构</h3> <p>提到多租户，我们可以首先可以联想到现实生活中的多租户的概念。<br> 比如我们公司租了一栋大楼里的一间房，我们和这栋大楼的其他租户是共享这栋大楼的基础设施，比如电力供应，自来水，电梯，物业安保等，但我们租的那间房只有我们公司的员工能进入和使用，其他租户的员工无权进入。我们要缴纳租金，我们使用的水电费等。</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/building-tenant-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/building-tenant-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/building-tenant-1400.webp"></source> <img src="/assets/img/building-tenant.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> 现实生活中大楼里的租户 </div> <p>同样的，软件世界里的多租户，也是类似的概念，同一个SaaS平台的租户共享硬件设备和存储等基础设施。同一个租户内的不同用户间共享数据，不同的租户间通过软件进行隔离。 还有需要注意的是，这里的多租户架构和传统的软件销售On-Premises方式，软件供应商给每个客户安装一套系统不同，这里的多租户架构是所有客户共享一套软件基础设施。</p> <ul> <li>概念 <ul> <li>多租户指得就是一个单独的软件实例可以为多个组织服务。</li> <li>设计上对数据和配置信息进行虚拟分区，需要对数据库结构进行特殊的设计。</li> <li>安全和隔离性要有所保障。</li> </ul> </li> <li>多租户和多用户的区别 <ul> <li>多用户的关键点在于不同的用户拥有不同的访问权限，但多个用户共享相同的业务数据；</li> <li>多租户间的业务数据是隔离的。</li> </ul> </li> <li>多租户和虚拟化的区别 <ul> <li>作用的层次不同，虚拟化是虚拟出一个操作系统，多租户是虚拟出一个应用实例。</li> </ul> </li> </ul> <h4 id="多租户架构的优缺点">多租户架构的优缺点</h4> <ul> <li>优点 <ul> <li>经济</li> <li>易于更新和开发</li> <li>管理方便</li> <li>One version, Bugs fixed for everyone</li> </ul> </li> <li>缺点 <ul> <li>更复杂</li> <li>不够安全/租户间隔离性</li> </ul> </li> </ul> <h4 id="多租户架构的几种模型">多租户架构的几种模型</h4> <p>区别主要在于采用不同的数据库模式（Database Schema)</p> <ul> <li>私有表 <ul> <li>机制：为每个租户的自定义数据创建一个新表</li> <li>优点：简单</li> <li>缺点：需要DDL操作，低整合度</li> </ul> </li> <li>扩展表 <ul> <li>机制：一个扩展表会被多个租户共享</li> <li>优点：高整合度，少DDL操作</li> <li>缺点：有点复杂</li> </ul> </li> <li>通用表 <ul> <li>机制：通过一个通用表来存放所有自定义信息</li> <li>优点：极高整合度，无DDL操作</li> <li>缺点：实现难度高</li> </ul> </li> </ul> <h4 id="salesforce的多租户架构">Salesforce的多租户架构</h4> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-multi-tenant-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-multi-tenant-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-multi-tenant-1400.webp"></source> <img src="/assets/img/salesforce-multi-tenant.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Salesforce的多租户架构 </div> <h3 id="元数据驱动metadata-driven">元数据驱动(Metadata Driven)</h3> <h4 id="什么是元数据">什么是元数据？</h4> <ul> <li>业务数据 <ul> <li>指的是客户，联系人，业务机会，合同等跟业务发生关联的数据。</li> </ul> </li> <li>元数据 <ul> <li>关于数据的数据</li> <li>指的是对象，字段，页面布局，验证规则，工作流等这类定义应用本身的数据。</li> <li>也被称为UDD （Universal Data Dictionary）通用数据字典</li> </ul> </li> </ul> <h4 id="元数据驱动的实现原理">元数据驱动的实现原理</h4> <p>理论上来说，我们只需要3张表就可以实现所有租户的所有需求。<br> 不同租户通过唯一的OrgID隔离，所有数据访问操作都要带OrgID参数，value0~value500存储对象的不同属性。</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/metadata1-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/metadata1-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/metadata1-1400.webp"></source> <img src="/assets/img/metadata1.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> 元数据驱动的实现原理 </div> <h4 id="salesforce数据层">Salesforce数据层</h4> <ul> <li>元数据表（Metadata Tables）</li> <li>数据表（Data Tables）</li> <li>索引表（Specialized Pivot tables）</li> </ul> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-data-layer-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-data-layer-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-data-layer-1400.webp"></source> <img src="/assets/img/salesforce-data-layer.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Salesforce数据层 </div> <h5 id="data表">Data表</h5> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-data-table-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-data-table-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-data-table-1400.webp"></source> <img src="/assets/img/salesforce-data-table.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Data表 </div> <p>大多数结构化数据都以可变字符串形式存储在value0~500的列里。（包括数字，日期等），但无法利用底层数据库索引的能力快速查询和排序？怎么解决呢？</p> <h5 id="indexes表">indexes表</h5> <p>解决方案是把数据拷贝出数据表并转换成原始的的数据类型，并存储到Indexes索引表列内，<br> Indexes 表的底层索引是标准的，采用非唯一性的数据库索引。<br> 查询先查indexes表，再查data表获取数据。<br> indexes表的字段定义如下：</p> <ul> <li>OrgID：其所归属的应用对象所归属的租户OrgID</li> <li>ObjID：字段所属应用对象唯一标识</li> <li>FieldNum：对象字段存储位置</li> <li>ObjInstanceGUID：对象实例唯一标识</li> <li>StringValue：强类型的字符串列</li> <li>NumValue：强类型的数字列</li> <li>DateValue：强类型的日期列</li> </ul> <h5 id="unique-indexes表">Unique Indexes表</h5> <p>这个表非常类似于 Indexes 表，不过 Unique indexes采用底层原生的数据库索引来强制唯一性校验。</p> <ul> <li>UniqueStringValue：唯一的字符串列</li> <li>UniqueNumValue：唯一的数字列</li> <li>UniqueDateValue：唯一的日期列</li> <li>其他字段定义请参考 Indexes 透视表</li> </ul> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-indexes-table-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-indexes-table-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-indexes-table-1400.webp"></source> <img src="/assets/img/salesforce-indexes-table.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-unique-indexes-table-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-unique-indexes-table-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-unique-indexes-table-1400.webp"></source> <img src="/assets/img/salesforce-unique-indexes-table.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> indexes表和unique indexes表 </div> <h5 id="relationship索引表">Relationship索引表</h5> <ul> <li>字段 <ul> <li>OrgID:租户ID</li> <li>ObjID:子对象的对象标识</li> <li>GUID：子对象实例的唯一表识</li> <li>RelationID：子对象内关系字段定义的标识</li> <li>TargetObjInstanceID：父对象实例的唯一标识</li> </ul> </li> <li>定义了两个底层数据库复合索引存储引用关系 <ul> <li>第一个索引字段：OrgID + GUID，用于从子对象到父对象的关联查询。</li> <li>第二个索引字段：OrgID + ObjID + RelationID + TargetObjInstanceID，用于父对象到子对象的关联查询。</li> </ul> <h5 id="如何支撑多租户巨大数据量">如何支撑多租户巨大数据量？</h5> </li> <li>Data Partitioning数据分区 <ul> <li>所有的 Force.com 的数据，元数据，透视表结构，包含底层数据库索引，都是通过对 OrgID 进行物理分区的，采用的是原生的数据库分区机制。</li> <li>数据分区是数据库系统提供的被验证过的技术，用以物理划分较大的逻辑数据结构到较小的可以管理的区块中。</li> </ul> </li> </ul> <h5 id="无感的对象结构变更no-ddl">无感的对象结构变更No DDL</h5> <ul> <li>在元数据驱动的数据架构中，所有的 DDL 语言操作对应的使元数据层的元数据的记录的更新，不涉及数据库物理结构的更新</li> <li>当用户修改了一个表字段列的数据结构，从一种数据类型改成另外一种不同存储格式的数据类型时候，系统会重新分派一个新的弹性列给到这个字段列的数据，将数据从原来的存储弹性列批量拷贝到新的弹性列，然后才会更新此字段列的元数据，暨在 Fields 表中更新这个字段列的元数据，将数据类型更改为新的数据类型，并将 FieldNum 更新为新的 ValueX 列对应的X值。</li> </ul> <h3 id="多租户隔离和保护">多租户隔离和保护</h3> <ul> <li>监控每一个代码执行片段</li> <li>限制代码CPU执行时间，内存使用量</li> <li>限制代码DB查询和更新数量</li> <li>限制可执行的数学运算量</li> <li>限制外部接口调用量</li> <li>执行太耗时或太耗资源的操作，系统将抛出运行时异常</li> <li>单元测试覆盖率必须超过75%</li> </ul> <p>因为是多租户共享，严格的限制保证整体的可扩展性和性能 <br> 长期来看，这些限制推动了开发写出了更好的代码</p> <h3 id="数据高可用">数据高可用</h3> <ul> <li>4 online copies</li> <li>2 standby copies</li> <li>本地热备切换速度更快</li> <li>异地热备使灾难切换少于15分钟</li> <li>每6个月切换一次（定期演练，验证）</li> </ul> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-data-availability-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-data-availability-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-data-availability-1400.webp"></source> <img src="/assets/img/salesforce-data-availability.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> 数据高可用 </div> <h3 id="可视化配置">可视化配置</h3> <h4 id="salesforce能配置什么">Salesforce能配置什么？</h4> <ul> <li>数据模型 <ul> <li>包括自定义的对象和它的相关字段，及其之间的关系。</li> <li>其实就是操作元数据</li> </ul> </li> <li>安全和共享模型 <ul> <li>包括用户，权限等</li> </ul> </li> <li>用户界面 <ul> <li>包括界面布局, 数据输入表单和报表等。</li> </ul> </li> <li>声明式逻辑 (工作流)</li> <li>编程式逻辑 (存储过程和触发器)</li> </ul> <h4 id="salesforce工作流">Salesforce工作流</h4> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce_flow-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce_flow-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce_flow-1400.webp"></source> <img src="/assets/img/salesforce_flow.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Salesforce工作流 </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce_flow_builder-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce_flow_builder-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce_flow_builder-1400.webp"></source> <img src="/assets/img/salesforce_flow_builder.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Salesforce工作流构建器 </div> <h4 id="配置数据模型和用户界面">配置数据模型和用户界面</h4> <ul> <li>对象管理器 <ul> <li>其实就是创建数据模型的地方，是后台配置对象，字段，页面布局等元数据的工具</li> </ul> </li> <li>配置用户界面 <ul> <li>列表视图 - 列表页 <ul> <li>在前端加载对象的记录列表时使用。例如客户列表</li> <li>利用元数据来展示业务数据。</li> </ul> </li> <li>页面布局 - (创建/更新/详情页） <ul> <li>在前端加载一条记录详情的时候使用，</li> <li>例如客户详情，新增/编辑客户信息页面。</li> </ul> </li> </ul> </li> </ul> <h5 id="可视化配置底层数据结构">可视化配置底层数据结构</h5> <p>橙色表示后台配置，蓝色表示前台界面</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-data-structure-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-data-structure-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-data-structure-1400.webp"></source> <img src="/assets/img/salesforce-data-structure.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> 可视化配置底层数据结构 </div> <h5 id="对象管理器">对象管理器</h5> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-object-manager-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-object-manager-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-object-manager-1400.webp"></source> <img src="/assets/img/salesforce-object-manager.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> 对象管理器 </div> <h5 id="对象object">对象（Object)</h5> <ul> <li>只有名称和APIName这两个重要的属性。</li> <li>创建一个新对象的时候，系统会自动帮你创建一些系统字段、一个页面布局，以及系统标准按钮数据。</li> <li>系统字段主要是指那些审计字段，例如：创建人、创建时间、最后更新人、最后更新时间、是否已删除等等。标准按钮主要是创建、编辑、删除等系统常规操作按钮。</li> </ul> <h5 id="字段field">字段（Field）</h5> <ul> <li>每个字段都需要有个数据类型</li> <li>一个字段只能属于1个对象</li> <li>字段的APIName在该对象上必须唯一</li> </ul> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-object-field-type-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-object-field-type-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-object-field-type-1400.webp"></source> <img src="/assets/img/salesforce-object-field-type.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> </div> <div class="col-sm mt-3 mt-md-0"> </div> </div> <div class="caption"> 字段的数据类型 </div> <h5 id="列表视图">列表视图</h5> <p>可灵活控制列表需要展示的字段和顺序。</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-list-view-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-list-view-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-list-view-1400.webp"></source> <img src="/assets/img/salesforce-list-view.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> 列表视图 </div> <h5 id="页面布局pagelayout">页面布局(PageLayout)</h5> <ul> <li>在前端加载一条记录详情的时候使用</li> <li>页面布局只要有2大块 <ul> <li>区域（PageLayoutSection）</li> <li>相关列表（RelatedList）</li> </ul> </li> <li>每个区域会有不同字段，可以是一列，两列，三列式</li> <li>相关列表指的是展示子记录的列表，可配置展示子记录的哪些列</li> </ul> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-page-layout-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-page-layout-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-page-layout-1400.webp"></source> <img src="/assets/img/salesforce-page-layout.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> 页面布局配置页面 </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-page-related-list-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-page-related-list-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-page-related-list-1400.webp"></source> <img src="/assets/img/salesforce-page-related-list.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> 相关列表配置页面 </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-detail-page-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-detail-page-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-detail-page-1400.webp"></source> <img src="/assets/img/salesforce-detail-page.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> 加载详情页面 </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/salesforce-edit-page-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/salesforce-edit-page-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/salesforce-edit-page-1400.webp"></source> <img src="/assets/img/salesforce-edit-page.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> 加载新建和编辑页面 </div> <h3 id="总结salesforce的设计理念">总结Salesforce的设计理念</h3> <ul> <li>数据驱动 <ul> <li>元数据驱动</li> </ul> </li> <li>规模经济 <ul> <li>尽可能多用户共享同一套系统</li> </ul> </li> <li>定制方便</li> <li>功能丰富 <ul> <li>能让用户购买和整合第三方应用（AppExchange）</li> </ul> </li> <li>软件是一个进化的工程 <ul> <li>不断丰富的产品矩阵</li> </ul> </li> </ul> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Jun Chen. Last updated: December 13, 2023. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>